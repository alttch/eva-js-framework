//0.1.8
"use strict";function _typeof(a){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function extend(){var a={},b=!1,c=0,d=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(b=arguments[0],c++);for(var e=function(c){for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=b&&"[object Object]"===Object.prototype.toString.call(c[d])?arguments.callee(!0,a[d],c[d]):c[d])};c<d;c++){var f=arguments[c];e(f)}return a}function cmp(c,a){if(c===void 0||a===void 0)return!1;var b=Object.getOwnPropertyNames(c),d=Object.getOwnPropertyNames(a);if(b.length!=d.length)return!1;for(var e,f=0;f<b.length;f++)if(e=b[f],!Array.isArray(c[e])&&c[e]!==a[e])return!1;return!0}function in_process(){return"undefined"!=typeof process&&"browser"!=process.title}var Logging=function(){function a(){_classCallCheck(this,a),this.log=console.log,this.colored=!0}return _createClass(a,[{key:"_msg",value:function _msg(a,b){if(2<arguments.length){var c=[].slice.call(arguments,2);if(this.colored){var d=[];if(b)c.map(function(a){a&&a.stack&&a.message||"object"===_typeof(a)?d.push(a):d.push(b(a))});else{for(var e,f,g=!!a,h=0;h<c.length;h++)f=c[h],!g||f&&f.stack&&f.message||"object"===_typeof(f)?(g&&(g=!1,d.push(e),d.push(a)),d.push(f),e=null):(e?e+=" ":e="%c",e+=f);e&&(d.push(e),d.push(a))}c=d}console.log.apply(null,c)}}},{key:"debug",value:function debug(){var a,b;"undefined"==typeof chalk?a="font-size: 12px; color: #999":b=chalk.gray,this._msg.apply(this,[a,b].concat(Array.from(arguments)))}},{key:"info",value:function info(){var a,b;"undefined"==typeof chalk?a="font-size: 12px; color: black":{},this._msg.apply(this,[a,b].concat(Array.from(arguments)))}},{key:"warning",value:function warning(){var a,b;"undefined"==typeof chalk?a="font-size: 14px; color: orange; font-weight: bold":b=chalk.bold.yellow,this._msg.apply(this,[a,b].concat(Array.from(arguments)))}},{key:"error",value:function error(){var a,b;"undefined"==typeof chalk?a="font-size: 14px; color: red; font-weight: bold":b=chalk.bold.red,this._msg.apply(this,[a,b].concat(Array.from(arguments)))}},{key:"critical",value:function critical(){var a,b;"undefined"==typeof chalk?a="font-size: 18px; color: red; font-weight: bold":b=chalk.bold.red,this._msg.apply(this,[a,b].concat(Array.from(arguments)))}}]),a}();if("undefined"==typeof _exports)var _exports={},jsaltt=_exports;_exports.logger=new Logging,_exports.Logging=Logging,_exports.extend=extend,_exports.cmp=cmp,"undefined"!=typeof jsaltt&&(_exports=void 0);function create_cookie(a,b,c,d){if("undefined"==typeof document)return!1;var e,f=void 0===d?"":d;if(c){var g=new Date;g.setTime(g.getTime()+1e3*(60*(60*(24*c)))),e=g.toUTCString()}else e="";return document.cookie="".concat(a,"=").concat(b,"; expires=").concat(e,"; path=").concat(f),!0}function read_cookie(a){if("undefined"!=typeof document){var b=a+"=";document.cookie.split(";").map(function(a){for(;" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(b))return a.substring(b.length,a.length)})}return null}function erase_cookie(a,b){return create_cookie(a,"",-1,b)}if("undefined"==typeof _exports)var _exports={},$cookies=_exports;_exports.read=read_cookie,_exports.reate=create_cookie,_exports.erase=erase_cookie,"undefined"!=typeof $cookies&&(_exports=void 0);var eva_sfa_framework_version="0.1.8";if("undefined"==typeof logger&&"undefined"!=typeof jsaltt)var logger=jsaltt.logger;else var logger={}[("debug","info","warning","error","critical")].map(function(a){return logger[a]=console.log});var EVA=function(){function EVA(){_classCallCheck(this,EVA),this.version=eva_sfa_framework_version,this.login="",this.password="",this.apikey="",this.api_uri="",this.set_auth_cookies=!0,this.global_cvars=!0,this.api_token="",this.authorized_user=null,this.logged_in=!1,this.debug=!1,this.state_updates=!0;try{this.ws_mode=!!WebSocket}catch(a){this.ws_mode=!1}this.ws=null,this.log={level:20,records:200},this._handlers={"heartbeat.error":this.restart},this._intervals={ajax_reload:2,ajax_log_reload:2,heartbeat:5,reload:5,restart:1},this.log_level_names={10:"DEBUG",20:"INFO",30:"WARNING",40:"ERROR",50:"CRITICAL"},this._heartbeat_reloader=null,this._ajax_reloader=null,this._log_reloader=null,this._scheduled_restarter=null,this._update_state_functions=[],this._update_state_mask_functions=[],this._clear()}return _createClass(EVA,[{key:"_clear",value:function _clear(){this.server_info=null,this.tsdiff=null,this._states=[],this._cvars={},this._log_subscribed=!1,this._log_first_load=!0,this._log_loaded=!1,this._log_started=!1,this._lr2p=[],this._last_ping=null,this._last_pong=null}},{key:"start",value:function start(){this._cancel_scheduled_restart(),this._debug("framework","version: ".concat(this.version));try{var a=fetch}catch(b){var a=null}if(!a)return logger.error("\"fetch\" function is unavailable. Upgrade your web browser or connect polyfill (lib/polyfill/fetch.js)"),!1;if(this.logged_in)return this._debug("start","already logged in"),!0;this._last_ping=null,this._last_pong=null;var b={};if(this.apikey)b={k:this.apikey},this._debug("start","logging in with API key");else if(this.password)b={u:this.login,p:this.password},this._debug("start","logging in with password");else if(this.set_auth_cookies){var c=$cookies.read("auth");c?(b={a:c},this._debug("start","logging in with auth token")):this._debug("start","logging in without credentials")}var d,e=this;return this._api_call("login",b).then(function(a){return e.api_token=a.token,d=a.user,e._set_token_cookie(),Promise.all([e._load_states(),e._heartbeat(e,!0),e._start_ws()])}).then(function(){e.ws_mode?(e._ajax_reloader&&clearInterval(e._ajax_reloader),e._intervals.reload&&(e._ajax_reloader=setInterval(function(){e._load_states(e).then(function(){})["catch"](function(){})},1e3*e._intervals.reload))):(e._ajax_reloader&&clearInterval(e._ajax_reloader),e._ajax_reloader=setInterval(function(){e._load_states(e).then(function(){})["catch"](function(){})},1e3*e._intervals.ajax_reload)),e._heartbeat_reloader&&clearInterval(e._heartbeat_reloader),e._heartbeat_reloader=setInterval(function(){e._heartbeat(e).then(function(){})["catch"](function(){})},1e3*e._intervals.heartbeat),e._debug("start","login successful, user: ".concat(d)),e.logged_in=!0,e.authorized_user=d,e._invoke_handler("login.success")})["catch"](function(a){e.logged_in=!1,void 0===a.code&&(a.code=4,a.message="Unknown error"),e._debug("start","login failed: ".concat(a.code," (").concat(a.message,")")),e._stop_engine(),e.erase_token_cookie(),e._invoke_handler("login.failed",a)}),!0}},{key:"log_start",value:function log_start(a){if(this._log_started=!0,void 0!==a&&(this.log.level=a),(!this.ws_mode||this._log_first_load)&&(this._log_loaded=!1,this._load_log_entries(!0),!this.ws_mode)){var b=this;this._log_reloader=setInterval(function(){b._load_log_entries(!1,b)},1e3*this._intervals.ajax_log_reload)}}},{key:"log_level",value:function log_level(a){this.log.level=a,this._set_ws_log_level(a),this._load_log_entries(!0)}},{key:"restart",value:function restart(){this._cancel_scheduled_restart(),this._debug("restart","performing restart");var a=this;this.stop().then(function(){a._schedule_restart()})["catch"](function(){a._schedule_restart()})}},{key:"erase_token_cookie",value:function erase_token_cookie(){this.api_token="",this.authorized_user=null,this._set_token_cookie()}},{key:"call",value:function call(a,b,c){var d;"string"==typeof b||Array.isArray(b)?(d=jsaltt.extend({},c),d.i=b):d=b;var e=this._prepare_call_params(d);return this._api_call(a,e)}},{key:"on",value:function on(a,b){this._handlers[a]=b,this._debug("on","setting handler for "+a)}},{key:"interval",value:function interval(a,b){this._intervals[a]=b}},{key:"cvar",value:function cvar(a){return this._cvars[a]}},{key:"watch",value:function watch(a,b){if(!a.includes("*")){a in this._update_state_functions||(this._update_state_functions[a]=[]),this._update_state_functions[a].push(b);var c=this.state(a);void 0!==c&&b(c)}else{a in this._update_state_mask_functions||(this._update_state_mask_functions[a]=[]),this._update_state_mask_functions[a].push(b);var d=this.state(a);Array.isArray(d)?d.map(b):b(d)}}},{key:"status",value:function status(a){var b=this.state(a);return void 0===b||null===b?void 0:b.status}},{key:"value",value:function value(a){var b=this.state(a);return void 0===b||null===b?void 0:+b.value==b.value?+b.value:b.value}},{key:"state",value:function state(a){if(!a.includes("*"))return a in this._states?this._states[a]:void 0;var b=[];return Object.keys(this._states).map(function(c){this._oid_match(c,a)&&b.push(this._states[c])},this),b}},{key:"expires_in",value:function expires_in(a){var b=this.state((a.startsWith("lvar:")?"":"lvar:")+a);if(void 0!==b){if(void 0===b.expires||0==b.expires)return null;if(null!=this.tsdiff){if(0==b.status)return-2;if(-1==b.status)return-1;var c=b.expires-new Date().getTime()/1e3+this.tsdiff+b.set_time;return 0>c&&(c=0),c}}}},{key:"stop",value:function stop(){var a=this;return new Promise(function(b,c){a._stop_engine(),a.logged_in=!1,a.call("logout").then(function(){a.erase_token_cookie(),b()})["catch"](function(b){a.erase_token_cookie(),c(b)})})}},{key:"_uuidv4",value:function _uuidv4(){var a=new Date().getTime(),b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var c=Math.floor,d=0|(a+16*Math.random())%16;return a=c(a/16),("x"==b?d:8|3&d).toString(16)});return b}},{key:"_api_call",value:function _api_call(a,b){var c=this._uuidv4(),d=this.api_uri+"/jrpc",e=this;return this._debug("_api_call","".concat(c,": ").concat(d,": ").concat(a)),new Promise(function(f,g){fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},redirect:"error",body:JSON.stringify({jsonrpc:"2.0",method:a,params:b,id:c})}).then(function(a){if(a.ok)e._debug("_api_call",c+" success"),a.json().then(function(a){!1 in a||a.id!=c||!1 in a&&!1 in a?g({code:9,message:"Invalid server response",data:a}):"error"in a?(e._debug("_api_call","".concat(c," failed: ").concat(a.error.code," (").concat(a.error.message,")")),g({code:a.error.code,message:a.error.message,data:a})):f(a.result)})["catch"](function(){var a="Invalid server response";e._debug("_api_call","".concat(c," failed: ").concat(9," (").concat(a,")")),g({code:9,message:a,data:data})});else{var b="Server error";e._debug("_api_call","".concat(c," failed: ").concat(7," (").concat(b,")")),g({code:7,message:b,data:data})}})["catch"](function(){var a="Server error";e._debug("_api_call","".concat(c," failed: ").concat(7," (").concat(a,")")),g({code:7,message:a,data:null})})})}},{key:"_heartbeat",value:function _heartbeat(me,on_login){return new Promise(function(resolve,reject){on_login&&(me._last_ping=null);var q={};if(on_login&&(q.icvars=1),me.ws_mode&&(null!==me._last_ping&&(null===me._last_pong||me._last_ping-me._last_pong>me._intervals.heartbeat)&&(me._debug("heartbeat","error: ws ping timeout"),me._invoke_handler("heartbeat.error")),!on_login&&me.ws)){me._last_ping=Date.now()/1e3;try{me._debug("heartbeat","ws ping"),me.ws.send(JSON.stringify({s:"ping"}))}catch(a){return me._debug("heartbeat","error: unable to send ws ping"),me._invoke_handler("heartbeat_error",a),void reject()}}me.call("test",q).then(function(data){me.server_info=data,me.tsdiff=new Date().getTime()/1e3-data.time,on_login&&(data.cvars?(me._cvars=data.cvars,me.global_cvars&&Object.keys(data.cvars).map(function(k){"undefined"!=typeof global&&eval("global.".concat(k,"=\"").concat(data.cvars[k],"\"")),"undefined"!=typeof window&&eval("window.".concat(k,"=\"").concat(data.cvars[k],"\""))})):me._cvars={}),me._invoke_handler("heartbeat.success"),resolve(!0)})["catch"](function(a){me._debug("heartbeat","error: unable to send test API call"),me._invoke_handler("heartbeat.error",a)}),me._debug("heartbeat","ok")})}},{key:"_load_log_entries",value:function _load_log_entries(a,b){if(!b)var b=this;b.ws_mode&&(b._lr2p=[]),b.call("log_get",{l:b.log.level,n:b.log.records}).then(function(c){b.ws_mode&&b._log_first_load&&b._set_ws_log_level(b.log.level),c.map(function(a){return b._invoke_handler("log.record",a)}),b._log_loaded=!0,b._lr2p.map(function(a){return b._invoke_handler("log.record",a)}),a&&b._invoke_handler("log.postprocess"),b._log_first_load=!1})["catch"](function(){logger.error("unable to load log entries")})}},{key:"_schedule_restart",value:function _schedule_restart(){var a=this;a._scheduled_restarter=setTimeout(function(){a.start()},1e3*a._intervals.restart)}},{key:"_cancel_scheduled_restart",value:function _cancel_scheduled_restart(){this._scheduled_restarter&&(clearTimeout(this._scheduled_restarter),this._scheduled_restarter=null)}},{key:"_stop_engine",value:function _stop_engine(){if(this._clear(),this._heartbeat_reloader&&(clearInterval(this._heartbeat_reloader),this._heartbeat_reloader=null),this._ajax_reloader&&(clearInterval(this._ajax_reloader),this._ajax_reloader=null),this._log_reloader&&(clearInterval(this._log_reloader),this._log_reloader=null),this.ws)try{this.ws.onclose=null,this.ws.onerror=function(){},this.ws.close()}catch(b){var a=this.ws;setTimeout(function(){try{a.close()}catch(a){}},1e3)}}},{key:"_prepare_call_params",value:function _prepare_call_params(a){var b=a?a:{};return this.api_token&&(b.k=this.api_token),b}},{key:"_set_token_cookie",value:function _set_token_cookie(){var a=this;this.set_auth_cookies&&"undefined"!=typeof document&&["/ui","/pvt","/rpvt"].map(function(b){return document.cookie="auth=".concat(a.api_token,"'; path=").concat(b)},this)}},{key:"_load_states",value:function _load_states(a){if(!a)var a=this;return new Promise(function(b,c){if(!a.state_updates)b(!0);else{var d={};if(!0!==a.state_updates){var e=a.state_updates.g,f=a.state_updates.p;e&&(d.g=e),f&&(d.p=f)}a.call("state_all",d).then(function(c){c.map(function(b){return a._process_state(b)}),b(!0)})["catch"](function(a){c(a)})}})}},{key:"_start_ws",value:function _start_ws(){var a=this;return new Promise(function(b){if(a.ws_mode){var c;if(!a.api_uri){var d=window.location;c="https:"===d.protocol?"wss:":"ws:",c+="//"+d.host}else c=a.api_uri;a.ws=new WebSocket("".concat(c,"/ws?k=").concat(a.api_token)),a.ws.onmessage=function(b){a._process_ws(b)},a.ws.addEventListener("open",function(){a._debug("_start_ws","ws connected");var b;if(a.state_updates&&(b={s:"state"},!0!==a.state_updates)){var c=a.state_updates.g;c||(c="#");var d=a.state_updates.p;d||(d="#"),b.g=c,b.tp=d,b.i=[]}b&&a.ws.send(JSON.stringify(b)),a._log_subscribed&&a.log_level(a.log.level)})}b(!0)})}},{key:"_set_ws_log_level",value:function _set_ws_log_level(a){this._log_subscribed=!0;try{this.ws&&this.ws.send(JSON.stringify({s:"log",l:a}))}catch(a){this._debug("log_level","warning: unable to send ws packet")}}},{key:"_process_ws",value:function _process_ws(a){var b=this,c=JSON.parse(a.data);return"pong"==c.s?(this._debug("ws","pong"),void(this._last_pong=Date.now()/1e3)):"reload"==c.s?(this._debug("ws","reload"),this._invoke_handler("server.reload")):"server"==c.s&&"restart"==c.d?(this._debug("ws","server_restart"),this._invoke_handler("server.restart")):!1===this._invoke_handler("ws.event",c)?void 0:"state"==c.s?(this._debug("ws","state"),void(Array.isArray(c.d)?c.d.map(function(a){return b._process_state(a)},this):this._process_state(c.d))):"log"==c.s?(Array.isArray(c.d)?c.d.map(function(a){return b._preprocess_log_record(a)},this):this._preprocess_log_record(c.d),void this._invoke_handler("log.postprocess")):void 0}},{key:"_preprocess_log_record",value:function _preprocess_log_record(a){this._log_loaded?this._invoke_handler("log.record",a):this._lr2p.push(a)}},{key:"_process_state",value:function _process_state(state){var z=[],x=[];try{var oid=state.oid;if(oid in this._states){var old_state=this._states[oid];z="",Object.keys(old_state).map(function(a){a in state||(state[a]=old_state[a])})}this._states[oid]=state,jsaltt.cmp(state,old_state)||(this._debug("process_state","".concat(oid," s: ").concat(state.status," v: \"").concat(state.value,"\""),"ns: ".concat(state.nstatus," nv: \"").concat(state.nvalue,"\"")),oid in this._update_state_functions&&this._update_state_functions[oid].map(function(f){try{"string"==typeof f||f instanceof String?eval(f):f(state)}catch(a){logger.error("state function processing for ".concat(oid,":"),a)}}),Object.keys(this._update_state_mask_functions).map(function(k){this._oid_match(oid,k)&&this._update_state_mask_functions[k].map(function(f){try{"string"==typeof f||f instanceof String?eval(f):f(state)}catch(a){logger.error("state function processing for ".concat(oid,":"),a)}})},this))}catch(a){logger.error("State processing error, invalid object received",a)}}},{key:"_invoke_handler",value:function _invoke_handler(handler){var f=this._handlers[handler];if(f){this._debug("invoke_handler","invoking for "+handler);try{if("string"==typeof f)return eval(f);if("function"==typeof f)return f.apply(this,Array.from(arguments))}catch(a){logger.error("handler for ".concat(handler,":"),a)}}}},{key:"_oid_match",value:function _oid_match(a,b){return new RegExp("^"+b.split("*").join(".*")+"$").test(a)}},{key:"_debug",value:function _debug(a){this.debug&&logger.debug.apply(logger,["EVA::"+a].concat([].slice.call(arguments,1)))}}]),EVA}();if("undefined"!=typeof _exports)_exports.EVA=EVA;else var $eva=new EVA;

